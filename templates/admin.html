<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de Administrador</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
</head>
<body>

  <!-- Header -->
  <header class="header">
    <div class="admin-header">
      <h1>🛡️ Panel de Administrador</h1>
      <div class="admin-nav">
        <a href="/dashboard" class="nav-link">Dashboard</a>
          <button onclick="showEditBannerModal()" class="nav-link edit-banner-btn" style="background: none; border: none; color: white; cursor: pointer; padding: 0.5rem 1rem; text-decoration: none;">✏️ Editar Banner</button>
          <a href="/logout" class="nav-link">Cerrar sesión</a>
      </div>
    </div>
  </header>

  <!-- Banner informativo -->
  <section class="info-banner">
    <div class="marquee-text">
      🛡️ PANEL ADMIN: GameStore Management System 🛡️ Gestión completa de usuarios y transacciones 🛡️ Supervisión en tiempo real de todas las operaciones 🛡️
    </div>
  </section>

  <!-- Panel de administrador con pestañas -->
  <section class="admin-panel">
    <div class="admin-stats">
      <div class="stat-card">
        <h3>Total Usuarios</h3>
        <span id="total-users">{{ users|length if users else 0 }}</span>
      </div>
      <div class="stat-card">
        <h3>Usuarios Activos</h3>
        <span id="active-users">{{ users|selectattr('is_active')|list|length if users else 0 }}</span>
      </div>
      <div class="stat-card">
        <h3>PINEs Disponibles</h3>
        <span id="available-pins">{{ pins_stats|sum(attribute='available') if pins_stats else 0 }}</span>
      </div>
    </div>

    <!-- Pestañas -->
    <div class="tab-container">
      <div class="tab-buttons">
        <button class="tab-button active" onclick="showTab('users')">👥 Usuarios</button>
        <button class="tab-button" onclick="showTab('pins')">📌 Agregar PINés</button>
      </div>

      <!-- Pestaña de Usuarios -->
      <div id="users-tab" class="tab-content active">
        <div class="users-section">
          <h2>Gestión de Usuarios</h2>
          <button onclick="refreshUsers()" class="btn-refresh">🔄 Actualizar</button>

          <div class="users-table-container">
            <table class="users-table">
              <thead>
                <tr>
                  <th>ID Usuario</th>
                  <th>Nombre</th>
                  <th>Email</th>
                  <th>Teléfono</th>
                  <th>Saldo</th>
                  <th>Estado</th>
                  <th>Fecha Registro</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="users-tbody">
                {% if users %}
                  {% for user in users %}
                  <tr data-user-id="{{ user.user_id }}">
                    <td>{{ user.user_id }}</td>
                    <td>{{ user.nombre }} {{ user.apellido }}</td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.telefono }}</td>
                    <td class="balance">${{ user.balance }}</td>
                    <td>
                      <span class="status {{ 'active' if user.is_active else 'inactive' }}">
                        {{ 'Activo' if user.is_active else 'Inactivo' }}
                      </span>
                    </td>
                    <td>{{ user.created_at.strftime('%d/%m/%Y') if user.created_at else '---' }}</td>
                    <td class="actions">
                      <button onclick="showCreditModal('{{ user.user_id }}', '{{ user.nombre }} {{ user.apellido }}')" 
                              class="btn-action btn-credit">💰</button>
                      <button onclick="showBalanceModal('{{ user.user_id }}', '{{ user.nombre }} {{ user.apellido }}', '{{ user.balance }}')" 
                              class="btn-action btn-balance">✏️</button>
                      <button onclick="toggleUserStatus('{{ user.user_id }}', {{ 'false' if user.is_active else 'true' }})" 
                              class="btn-action btn-toggle">
                        {{ '🔒' if user.is_active else '🔓' }}
                      </button>
                      <button onclick="deleteUser('{{ user.user_id }}', '{{ user.nombre }} {{ user.apellido }}')" 
                              class="btn-action btn-delete">🗑️</button>
                    </td>
                  </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="8" class="no-users">No hay usuarios registrados</td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Pestaña de PINés -->
      <div id="pins-tab" class="tab-content">
        <div class="pins-section">
          <h2>Gestión de PINés</h2>

          <!-- Formulario para agregar PINés -->
          <div class="add-pins-form">
            <h3>Agregar Nuevo PIN</h3>
            <form onsubmit="addSinglePin(event)">
              <div class="form-row">
                <div class="form-group">
                  <label for="pin-code">Código del PIN:</label>
                  <input type="text" id="pin-code" placeholder="Ej: ABC123XY" maxlength="20" required>
                </div>
                <div class="form-group">
                  <label for="pin-value">Valor del PIN:</label>
                  <select id="pin-value" required>
                    <option value="">-- Seleccionar valor --</option>
                    <option value="1">Opción 1 - 110 💎 / $0.66</option>
                    <option value="2">Opción 2 - 341 💎 / $1.99</option>
                    <option value="3">Opción 3 - 572 💎 / $3.35</option>
                    <option value="4">Opción 4 - 1.166 💎 / $6.70</option>
                    <option value="5">Opción 5 - 2.376 💎 / $12.70</option>
                    <option value="6">Opción 6 - 6.138 💎 / $29.50</option>
                    <option value="7">Opción 7 - Tarjeta básica / $0.40</option>
                    <option value="8">Opción 8 - Tarjeta semanal / $1.40</option>
                    <option value="9">Opción 9 - Tarjeta mensual / $6.50</option>
                  </select>
                </div>
                <div class="form-group">
                  <button type="submit" class="btn btn-success">Agregar PIN</button>
                </div>
              </div>
            </form>
          </div>

          <!-- Estadísticas de PINés -->
          <div class="pins-stats">
            <h3>Estadísticas de PINés</h3>
            <div class="stats-grid">
              {% if pins_stats %}
                {% for stat in pins_stats %}
                <div class="stat-item">
                  <div class="stat-value">${{ stat.value }}</div>
                  <div class="stat-details">
                    <span class="available">{{ stat.available }} disponibles</span>
                    <span class="used">{{ stat.used }} usados</span>
                    <span class="total">{{ stat.total }} total</span>
                  </div>
                </div>
                {% endfor %}
              {% else %}
                <p>No hay PINés en el sistema</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Modal para agregar crédito -->
  <div id="creditModal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close" onclick="closeCreditModal()">&times;</span>
      <h3>Agregar Crédito</h3>
      <p>Usuario: <span id="credit-user-name"></span></p>
      <div class="form-group">
        <label for="credit-amount">Monto a agregar:</label>
        <input type="number" id="credit-amount" min="0.01" step="0.01" placeholder="0.00">
      </div>
      <div class="modal-actions">
        <button onclick="addCredit()" class="btn btn-success">Agregar Crédito</button>
        <button onclick="closeCreditModal()" class="btn btn-cancel">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal para editar saldo -->
  <div id="balanceModal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close" onclick="closeBalanceModal()">&times;</span>
      <h3>Editar Saldo</h3>
      <p>Usuario: <span id="balance-user-name"></span></p>
      <p>Saldo actual: $<span id="current-balance"></span></p>
      <div class="form-group">
        <label for="new-balance">Nuevo saldo:</label>
        <input type="number" id="new-balance" min="0" step="0.01" placeholder="0.00">
      </div>
      <div class="modal-actions">
        <button onclick="setBalance()" class="btn btn-success">Actualizar Saldo</button>
        <button onclick="closeBalanceModal()" class="btn btn-cancel">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal de confirmación -->
  <div id="confirmModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h3 id="confirm-title">Confirmar acción</h3>
      <p id="confirm-message"></p>
      <div class="modal-actions">
        <button id="confirm-btn" class="btn btn-danger">Confirmar</button>
        <button onclick="closeConfirmModal()" class="btn btn-cancel">Cancelar</button>
      </div>
    </div>
  </div>

    <!-- Modal para editar banner -->
    <div id="editBannerModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeEditBannerModal()">&times;</span>
            <h3>Editar Texto del Banner</h3>
            <div class="form-group">
                <label for="banner-text">Nuevo texto del banner:</label>
                <input type="text" id="banner-text" placeholder="Ingrese el nuevo texto aquí">
            </div>
            <div class="modal-actions">
                <button onclick="updateBannerText()" class="btn btn-success">Actualizar Banner</button>
                <button onclick="closeEditBannerModal()" class="btn btn-cancel">Cancelar</button>
            </div>
        </div>
    </div>

  <script>
    let selectedUserId = null;

    // Mapeo de valores a precios reales (igual que en freefirelatam.html)
    const priceMapping = {
      '1': 0.66,  // 110 💎
      '2': 1.99,  // 341 💎  
      '3': 3.35,  // 572 💎
      '4': 6.70,  // 1.166 💎
      '5': 12.70, // 2.376 💎
      '6': 29.50, // 6.138 💎
      '7': 0.40,  // Tarjeta básica
      '8': 1.40,  // Tarjeta semanal
      '9': 6.50   // Tarjeta mensual
    };

    function showTab(tabName) {
      // Ocultar todas las pestañas
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });

      // Mostrar la pestaña seleccionada
      document.getElementById(tabName + '-tab').classList.add('active');
      event.target.classList.add('active');
    }

    function refreshUsers() {
      location.reload();
    }

    async function addSinglePin(event) {
      event.preventDefault();

      const pinCode = document.getElementById('pin-code').value.trim().toUpperCase();
      const optionValue = document.getElementById('pin-value').value;

      if (!pinCode || !optionValue) {
        alert('Por favor completa todos los campos');
        return;
      }

      if (pinCode.length < 4) {
        alert('El PIN debe tener al menos 4 caracteres');
        return;
      }

      const realPrice = priceMapping[optionValue];
      if (!realPrice) {
        alert('Valor de opción inválido');
        return;
      }

      try {
        const response = await fetch('/admin/add-single-pin', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            pin_code: pinCode,
            value: parseInt(optionValue) // Enviar el valor de opción (1-9)
          })
        });

        const data = await response.json();

        if (data.success) {
          alert(`PIN "${pinCode}" de opción ${optionValue} ($${realPrice}) agregado exitosamente`);
          document.getElementById('pin-code').value = '';
          document.getElementById('pin-value').value = '';
          location.reload();
        } else {
          alert(data.error);
        }
      } catch (error) {
        alert('Error al agregar PIN');
      }
    }

    function showCreditModal(userId, userName) {
      selectedUserId = userId;
      document.getElementById('credit-user-name').textContent = userName;
      document.getElementById('creditModal').style.display = 'block';
    }

    function closeCreditModal() {
      document.getElementById('creditModal').style.display = 'none';
      document.getElementById('credit-amount').value = '';
      selectedUserId = null;
    }

    function showBalanceModal(userId, userName, currentBalance) {
      selectedUserId = userId;
      document.getElementById('balance-user-name').textContent = userName;
      document.getElementById('current-balance').textContent = currentBalance;
      document.getElementById('new-balance').value = currentBalance;
      document.getElementById('balanceModal').style.display = 'block';
    }

    function closeBalanceModal() {
      document.getElementById('balanceModal').style.display = 'none';
      document.getElementById('new-balance').value = '';
      selectedUserId = null;
    }

    function closeConfirmModal() {
      document.getElementById('confirmModal').style.display = 'none';
    }

        function showEditBannerModal() {
            document.getElementById('editBannerModal').style.display = 'block';
        }

        function closeEditBannerModal() {
            document.getElementById('editBannerModal').style.display = 'none';
            document.getElementById('banner-text').value = '';
        }

        async function updateBannerText() {
            const bannerText = document.getElementById('banner-text').value;

            if (!bannerText) {
                alert('Por favor, ingrese el nuevo texto para el banner.');
                return;
            }

            try {
                const response = await fetch('/admin/update-banner', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ banner_text: bannerText })
                });

                const data = await response.json();

                if (data.success) {
                    // Actualizar el texto del banner en la página
                    document.querySelector('.marquee-text').textContent = bannerText;
                    alert('Texto del banner actualizado con éxito.');
                    closeEditBannerModal();
                } else {
                    alert(data.error);
                }
            } catch (error) {
                alert('Error al actualizar el texto del banner: ' + error);
            }
        }

    async function addCredit() {
      const amount = document.getElementById('credit-amount').value;

      if (!amount || amount <= 0) {
        alert('Por favor ingresa un monto válido');
        return;
      }

      try {
        const response = await fetch(`/admin/user/${selectedUserId}/add-credit`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            user_id: selectedUserId,
            amount: amount
          })
        });

        const data = await response.json();

        if (data.success) {
          const row = document.querySelector(`tr[data-user-id="${selectedUserId}"]`);
          const balanceCell = row.querySelector('.balance');
          balanceCell.textContent = '$' + data.new_balance;

          alert(data.message);
          closeCreditModal();
        } else {
          alert(data.error);
        }
      } catch (error) {
        alert('Error al agregar crédito');
      }
    }

    async function setBalance() {
      const newBalance = document.getElementById('new-balance').value;

      if (newBalance === '' || newBalance < 0) {
        alert('Por favor ingresa un saldo válido');
        return;
      }

      try {
        const response = await fetch(`/admin/user/${selectedUserId}/set-balance`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            balance: newBalance
          })
        });

        const data = await response.json();

        if (data.success) {
          const row = document.querySelector(`tr[data-user-id="${selectedUserId}"]`);
          const balanceCell = row.querySelector('.balance');
          balanceCell.textContent = '$' + data.new_balance;

          alert(data.message);
          closeBalanceModal();
        } else {
          alert(data.error);
        }
      } catch (error) {
        alert('Error al actualizar saldo');
      }
    }

    function toggleUserStatus(userId, activate) {
      const action = activate === 'true' ? 'activate' : 'deactivate';
      const message = activate === 'true' ? '¿Activar este usuario?' : '¿Desactivar este usuario?';

      document.getElementById('confirm-title').textContent = 'Cambiar estado de usuario';
      document.getElementById('confirm-message').textContent = message;
      document.getElementById('confirm-btn').onclick = () => executeToggleUser(userId, action);
      document.getElementById('confirmModal').style.display = 'block';
    }

    async function executeToggleUser(userId, action) {
      try {
        const response = await fetch(`/admin/user/${userId}/toggle`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            user_id: userId,
            action: action
          })
        });

        const data = await response.json();

        if (data.success) {
          location.reload();
        } else {
          alert(data.error);
        }
      } catch (error) {
        alert('Error al cambiar estado del usuario');
      }

      closeConfirmModal();
    }

    function deleteUser(userId, userName) {
      document.getElementById('confirm-title').textContent = 'Eliminar usuario';
      document.getElementById('confirm-message').textContent = `¿Estás seguro de eliminar al usuario "${userName}"? Esta acción no se puede deshacer.`;
      document.getElementById('confirm-btn').onclick = () => executeDeleteUser(userId);
      document.getElementById('confirmModal').style.display = 'block';
    }

    async function executeDeleteUser(userId) {
      try {
        const response = await fetch(`/admin/user/${userId}/delete`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            user_id: userId
          })
        });

        const data = await response.json();

        if (data.success) {
          location.reload();
        } else {
          alert(data.error);
        }
      } catch (error) {
        alert('Error al eliminar usuario');
      }

      closeConfirmModal();
    }

    // Cerrar modales al hacer clic fuera
    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
      }
    }
  </script>
</body>
</html>