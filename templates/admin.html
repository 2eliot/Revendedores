
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de Administrador</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
</head>
<body>

  <!-- Header -->
  <header class="header">
    <div class="admin-header">
      <h1>üõ°Ô∏è Panel de Administrador</h1>
      <div class="admin-nav">
        <a href="/dashboard" class="nav-link">Dashboard</a>
        <a href="/logout" class="nav-link">Cerrar sesi√≥n</a>
      </div>
    </div>
  </header>

  <!-- Panel de administrador con pesta√±as -->
  <section class="admin-panel">
    <div class="admin-stats">
      <div class="stat-card">
        <h3>Total Usuarios</h3>
        <span id="total-users">{{ users|length if users else 0 }}</span>
      </div>
      <div class="stat-card">
        <h3>Usuarios Activos</h3>
        <span id="active-users">{{ users|selectattr('is_active')|list|length if users else 0 }}</span>
      </div>
      <div class="stat-card">
        <h3>PINEs Disponibles</h3>
        <span id="available-pins">{{ pins_stats|sum(attribute='available') if pins_stats else 0 }}</span>
      </div>
    </div>

    <!-- Pesta√±as -->
    <div class="tab-container">
      <div class="tab-buttons">
        <button class="tab-button active" onclick="showTab('users')">üë• Usuarios</button>
        <button class="tab-button" onclick="showTab('pins')">üìå Agregar PIN√©s</button>
      </div>

      <!-- Pesta√±a de Usuarios -->
      <div id="users-tab" class="tab-content active">
        <div class="users-section">
          <h2>Gesti√≥n de Usuarios</h2>
          <button onclick="refreshUsers()" class="btn-refresh">üîÑ Actualizar</button>
          
          <div class="users-table-container">
            <table class="users-table">
              <thead>
                <tr>
                  <th>ID Usuario</th>
                  <th>Nombre</th>
                  <th>Email</th>
                  <th>Tel√©fono</th>
                  <th>Saldo</th>
                  <th>Estado</th>
                  <th>Fecha Registro</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="users-tbody">
                {% if users %}
                  {% for user in users %}
                  <tr data-user-id="{{ user.user_id }}">
                    <td>{{ user.user_id }}</td>
                    <td>{{ user.nombre }} {{ user.apellido }}</td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.telefono }}</td>
                    <td class="balance">${{ user.balance }}</td>
                    <td>
                      <span class="status {{ 'active' if user.is_active else 'inactive' }}">
                        {{ 'Activo' if user.is_active else 'Inactivo' }}
                      </span>
                    </td>
                    <td>{{ user.created_at.strftime('%d/%m/%Y') if user.created_at else '---' }}</td>
                    <td class="actions">
                      <button onclick="showCreditModal('{{ user.user_id }}', '{{ user.nombre }} {{ user.apellido }}')" 
                              class="btn-action btn-credit">üí∞</button>
                      <button onclick="showBalanceModal('{{ user.user_id }}', '{{ user.nombre }} {{ user.apellido }}', '{{ user.balance }}')" 
                              class="btn-action btn-balance">‚úèÔ∏è</button>
                      <button onclick="toggleUserStatus('{{ user.user_id }}', {{ 'false' if user.is_active else 'true' }})" 
                              class="btn-action btn-toggle">
                        {{ 'üîí' if user.is_active else 'üîì' }}
                      </button>
                      <button onclick="deleteUser('{{ user.user_id }}', '{{ user.nombre }} {{ user.apellido }}')" 
                              class="btn-action btn-delete">üóëÔ∏è</button>
                    </td>
                  </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="8" class="no-users">No hay usuarios registrados</td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Pesta√±a de PIN√©s -->
      <div id="pins-tab" class="tab-content">
        <div class="pins-section">
          <h2>Gesti√≥n de PIN√©s</h2>
          
          <!-- Formulario para agregar PIN√©s -->
          <div class="add-pins-form">
            <h3>Agregar Nuevo PIN</h3>
            <form onsubmit="addSinglePin(event)">
              <div class="form-row">
                <div class="form-group">
                  <label for="pin-code">C√≥digo del PIN:</label>
                  <input type="text" id="pin-code" placeholder="Ej: ABC123XY" maxlength="20" required>
                </div>
                <div class="form-group">
                  <label for="pin-value">Valor del PIN:</label>
                  <select id="pin-value" required>
                    <option value="">-- Seleccionar valor --</option>
                    <option value="1.99">$1.99</option>
                    <option value="4.99">$4.99</option>
                    <option value="9.99">$9.99</option>
                    <option value="19.99">$19.99</option>
                    <option value="39.99">$39.99</option>
                    <option value="99.99">$99.99</option>
                  </select>
                </div>
                <div class="form-group">
                  <button type="submit" class="btn btn-success">Agregar PIN</button>
                </div>
              </div>
            </form>
          </div>

          <!-- Estad√≠sticas de PIN√©s -->
          <div class="pins-stats">
            <h3>Estad√≠sticas de PIN√©s</h3>
            <div class="stats-grid">
              {% if pins_stats %}
                {% for stat in pins_stats %}
                <div class="stat-item">
                  <div class="stat-value">${{ stat.value }}</div>
                  <div class="stat-details">
                    <span class="available">{{ stat.available }} disponibles</span>
                    <span class="used">{{ stat.used }} usados</span>
                    <span class="total">{{ stat.total }} total</span>
                  </div>
                </div>
                {% endfor %}
              {% else %}
                <p>No hay PIN√©s en el sistema</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Modal para agregar cr√©dito -->
  <div id="creditModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeCreditModal()">&times;</span>
      <h3>Agregar Cr√©dito</h3>
      <p>Usuario: <span id="credit-user-name"></span></p>
      <div class="form-group">
        <label for="credit-amount">Monto a agregar:</label>
        <input type="number" id="credit-amount" min="0.01" step="0.01" placeholder="0.00">
      </div>
      <div class="modal-actions">
        <button onclick="addCredit()" class="btn btn-success">Agregar Cr√©dito</button>
        <button onclick="closeCreditModal()" class="btn btn-cancel">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal para editar saldo -->
  <div id="balanceModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeBalanceModal()">&times;</span>
      <h3>Editar Saldo</h3>
      <p>Usuario: <span id="balance-user-name"></span></p>
      <p>Saldo actual: $<span id="current-balance"></span></p>
      <div class="form-group">
        <label for="new-balance">Nuevo saldo:</label>
        <input type="number" id="new-balance" min="0" step="0.01" placeholder="0.00">
      </div>
      <div class="modal-actions">
        <button onclick="setBalance()" class="btn btn-success">Actualizar Saldo</button>
        <button onclick="closeBalanceModal()" class="btn btn-cancel">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal de confirmaci√≥n -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <h3 id="confirm-title">Confirmar acci√≥n</h3>
      <p id="confirm-message"></p>
      <div class="modal-actions">
        <button id="confirm-btn" class="btn btn-danger">Confirmar</button>
        <button onclick="closeConfirmModal()" class="btn btn-cancel">Cancelar</button>
      </div>
    </div>
  </div>

  <script>
    let selectedUserId = null;

    function showTab(tabName) {
      // Ocultar todas las pesta√±as
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });

      // Mostrar la pesta√±a seleccionada
      document.getElementById(tabName + '-tab').classList.add('active');
      event.target.classList.add('active');
    }

    function refreshUsers() {
      location.reload();
    }

    async function addSinglePin(event) {
      event.preventDefault();
      
      const pinCode = document.getElementById('pin-code').value.trim().toUpperCase();
      const value = document.getElementById('pin-value').value;
      
      if (!pinCode || !value) {
        alert('Por favor completa todos los campos');
        return;
      }

      if (pinCode.length < 4) {
        alert('El PIN debe tener al menos 4 caracteres');
        return;
      }

      try {
        const response = await fetch('/admin/add-single-pin', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            pin_code: pinCode,
            value: parseFloat(value)
          })
        });

        const data = await response.json();

        if (data.success) {
          alert(`PIN "${pinCode}" de $${value} agregado exitosamente`);
          document.getElementById('pin-code').value = '';
          document.getElementById('pin-value').value = '';
          location.reload();
        } else {
          alert(data.error);
        }
      } catch (error) {
        alert('Error al agregar PIN');
      }
    }

    function showCreditModal(userId, userName) {
      selectedUserId = userId;
      document.getElementById('credit-user-name').textContent = userName;
      document.getElementById('creditModal').style.display = 'block';
    }

    function closeCreditModal() {
      document.getElementById('creditModal').style.display = 'none';
      document.getElementById('credit-amount').value = '';
      selectedUserId = null;
    }

    function showBalanceModal(userId, userName, currentBalance) {
      selectedUserId = userId;
      document.getElementById('balance-user-name').textContent = userName;
      document.getElementById('current-balance').textContent = currentBalance;
      document.getElementById('new-balance').value = currentBalance;
      document.getElementById('balanceModal').style.display = 'block';
    }

    function closeBalanceModal() {
      document.getElementById('balanceModal').style.display = 'none';
      document.getElementById('new-balance').value = '';
      selectedUserId = null;
    }

    function closeConfirmModal() {
      document.getElementById('confirmModal').style.display = 'none';
    }

    async function addCredit() {
      const amount = document.getElementById('credit-amount').value;
      
      if (!amount || amount <= 0) {
        alert('Por favor ingresa un monto v√°lido');
        return;
      }

      try {
        const response = await fetch(`/admin/user/${selectedUserId}/add-credit`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            user_id: selectedUserId,
            amount: amount
          })
        });

        const data = await response.json();

        if (data.success) {
          const row = document.querySelector(`tr[data-user-id="${selectedUserId}"]`);
          const balanceCell = row.querySelector('.balance');
          balanceCell.textContent = '$' + data.new_balance;
          
          alert(data.message);
          closeCreditModal();
        } else {
          alert(data.error);
        }
      } catch (error) {
        alert('Error al agregar cr√©dito');
      }
    }

    async function setBalance() {
      const newBalance = document.getElementById('new-balance').value;
      
      if (newBalance === '' || newBalance < 0) {
        alert('Por favor ingresa un saldo v√°lido');
        return;
      }

      try {
        const response = await fetch(`/admin/user/${selectedUserId}/set-balance`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            balance: newBalance
          })
        });

        const data = await response.json();

        if (data.success) {
          const row = document.querySelector(`tr[data-user-id="${selectedUserId}"]`);
          const balanceCell = row.querySelector('.balance');
          balanceCell.textContent = '$' + data.new_balance;
          
          alert(data.message);
          closeBalanceModal();
        } else {
          alert(data.error);
        }
      } catch (error) {
        alert('Error al actualizar saldo');
      }
    }

    function toggleUserStatus(userId, activate) {
      const action = activate === 'true' ? 'activate' : 'deactivate';
      const message = activate === 'true' ? '¬øActivar este usuario?' : '¬øDesactivar este usuario?';
      
      document.getElementById('confirm-title').textContent = 'Cambiar estado de usuario';
      document.getElementById('confirm-message').textContent = message;
      document.getElementById('confirm-btn').onclick = () => executeToggleUser(userId, action);
      document.getElementById('confirmModal').style.display = 'block';
    }

    async function executeToggleUser(userId, action) {
      try {
        const response = await fetch(`/admin/user/${userId}/toggle`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            user_id: userId,
            action: action
          })
        });

        const data = await response.json();

        if (data.success) {
          location.reload();
        } else {
          alert(data.error);
        }
      } catch (error) {
        alert('Error al cambiar estado del usuario');
      }
      
      closeConfirmModal();
    }

    function deleteUser(userId, userName) {
      document.getElementById('confirm-title').textContent = 'Eliminar usuario';
      document.getElementById('confirm-message').textContent = `¬øEst√°s seguro de eliminar al usuario "${userName}"? Esta acci√≥n no se puede deshacer.`;
      document.getElementById('confirm-btn').onclick = () => executeDeleteUser(userId);
      document.getElementById('confirmModal').style.display = 'block';
    }

    async function executeDeleteUser(userId) {
      try {
        const response = await fetch(`/admin/user/${userId}/delete`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            user_id: userId
          })
        });

        const data = await response.json();

        if (data.success) {
          location.reload();
        } else {
          alert(data.error);
        }
      } catch (error) {
        alert('Error al eliminar usuario');
      }
      
      closeConfirmModal();
    }

    // Cerrar modales al hacer clic fuera
    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
      }
    }
  </script>
</body>
</html>
