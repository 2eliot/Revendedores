
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de Administrador</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
</head>
<body>

  <!-- Header -->
  <header class="header">
    <div class="admin-header">
      <h1>üõ°Ô∏è Panel de Administrador</h1>
      <div class="admin-nav">
        <a href="/dashboard" class="nav-link">Dashboard</a>
        <a href="/logout" class="nav-link">Cerrar sesi√≥n</a>
      </div>
    </div>
  </header>

  <!-- Panel de administrador -->
  <section class="admin-panel">
    <div class="admin-stats">
      <div class="stat-card">
        <h3>Total Usuarios</h3>
        <span id="total-users">{{ users|length if users else 0 }}</span>
      </div>
      <div class="stat-card">
        <h3>Usuarios Activos</h3>
        <span id="active-users">{{ users|selectattr('is_active')|list|length if users else 0 }}</span>
      </div>
    </div>

    <div class="users-section">
      <h2>Gesti√≥n de Usuarios</h2>
      <button onclick="refreshUsers()" class="btn-refresh">üîÑ Actualizar</button>
      
      <div class="users-table-container">
        <table class="users-table">
          <thead>
            <tr>
              <th>ID Usuario</th>
              <th>Nombre</th>
              <th>Email</th>
              <th>Tel√©fono</th>
              <th>Saldo</th>
              <th>Estado</th>
              <th>Fecha Registro</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="users-tbody">
            {% if users %}
              {% for user in users %}
              <tr data-user-id="{{ user.user_id }}">
                <td>{{ user.user_id }}</td>
                <td>{{ user.nombre }} {{ user.apellido }}</td>
                <td>{{ user.email }}</td>
                <td>{{ user.telefono }}</td>
                <td class="balance">${{ user.balance }}</td>
                <td>
                  <span class="status {{ 'active' if user.is_active else 'inactive' }}">
                    {{ 'Activo' if user.is_active else 'Inactivo' }}
                  </span>
                </td>
                <td>{{ user.created_at.strftime('%d/%m/%Y') if user.created_at else '---' }}</td>
                <td class="actions">
                  <button onclick="showCreditModal('{{ user.user_id }}', '{{ user.nombre }} {{ user.apellido }}')" 
                          class="btn-action btn-credit">üí∞</button>
                  <button onclick="toggleUserStatus('{{ user.user_id }}', {{ 'false' if user.is_active else 'true' }})" 
                          class="btn-action btn-toggle">
                    {{ 'üîí' if user.is_active else 'üîì' }}
                  </button>
                  <button onclick="deleteUser('{{ user.user_id }}', '{{ user.nombre }} {{ user.apellido }}')" 
                          class="btn-action btn-delete">üóëÔ∏è</button>
                </td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="8" class="no-users">No hay usuarios registrados</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Modal para agregar cr√©dito -->
  <div id="creditModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeCreditModal()">&times;</span>
      <h3>Agregar Cr√©dito</h3>
      <p>Usuario: <span id="credit-user-name"></span></p>
      <div class="form-group">
        <label for="credit-amount">Monto a agregar:</label>
        <input type="number" id="credit-amount" min="0.01" step="0.01" placeholder="0.00">
      </div>
      <div class="modal-actions">
        <button onclick="addCredit()" class="btn btn-success">Agregar Cr√©dito</button>
        <button onclick="closeCreditModal()" class="btn btn-cancel">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal de confirmaci√≥n -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <h3 id="confirm-title">Confirmar acci√≥n</h3>
      <p id="confirm-message"></p>
      <div class="modal-actions">
        <button id="confirm-btn" class="btn btn-danger">Confirmar</button>
        <button onclick="closeConfirmModal()" class="btn btn-cancel">Cancelar</button>
      </div>
    </div>
  </div>

  <script>
    let selectedUserId = null;

    function refreshUsers() {
      location.reload();
    }

    function showCreditModal(userId, userName) {
      selectedUserId = userId;
      document.getElementById('credit-user-name').textContent = userName;
      document.getElementById('creditModal').style.display = 'block';
    }

    function closeCreditModal() {
      document.getElementById('creditModal').style.display = 'none';
      document.getElementById('credit-amount').value = '';
      selectedUserId = null;
    }

    function closeConfirmModal() {
      document.getElementById('confirmModal').style.display = 'none';
    }

    async function addCredit() {
      const amount = document.getElementById('credit-amount').value;
      
      if (!amount || amount <= 0) {
        alert('Por favor ingresa un monto v√°lido');
        return;
      }

      try {
        const response = await fetch(`/admin/user/${selectedUserId}/add-credit`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            user_id: selectedUserId,
            amount: amount
          })
        });

        const data = await response.json();

        if (data.success) {
          // Actualizar el saldo en la tabla
          const row = document.querySelector(`tr[data-user-id="${selectedUserId}"]`);
          const balanceCell = row.querySelector('.balance');
          balanceCell.textContent = '$' + data.new_balance;
          
          alert(data.message);
          closeCreditModal();
        } else {
          alert(data.error);
        }
      } catch (error) {
        alert('Error al agregar cr√©dito');
      }
    }

    function toggleUserStatus(userId, activate) {
      const action = activate === 'true' ? 'activate' : 'deactivate';
      const message = activate === 'true' ? '¬øActivar este usuario?' : '¬øDesactivar este usuario?';
      
      document.getElementById('confirm-title').textContent = 'Cambiar estado de usuario';
      document.getElementById('confirm-message').textContent = message;
      document.getElementById('confirm-btn').onclick = () => executeToggleUser(userId, action);
      document.getElementById('confirmModal').style.display = 'block';
    }

    async function executeToggleUser(userId, action) {
      try {
        const response = await fetch(`/admin/user/${userId}/toggle`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            user_id: userId,
            action: action
          })
        });

        const data = await response.json();

        if (data.success) {
          location.reload();
        } else {
          alert(data.error);
        }
      } catch (error) {
        alert('Error al cambiar estado del usuario');
      }
      
      closeConfirmModal();
    }

    function deleteUser(userId, userName) {
      document.getElementById('confirm-title').textContent = 'Eliminar usuario';
      document.getElementById('confirm-message').textContent = `¬øEst√°s seguro de eliminar al usuario "${userName}"? Esta acci√≥n no se puede deshacer.`;
      document.getElementById('confirm-btn').onclick = () => executeDeleteUser(userId);
      document.getElementById('confirmModal').style.display = 'block';
    }

    async function executeDeleteUser(userId) {
      try {
        const response = await fetch(`/admin/user/${userId}/delete`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            user_id: userId
          })
        });

        const data = await response.json();

        if (data.success) {
          location.reload();
        } else {
          alert(data.error);
        }
      } catch (error) {
        alert('Error al eliminar usuario');
      }
      
      closeConfirmModal();
    }

    // Cerrar modales al hacer clic fuera
    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
      }
    }
  </script>
</body>
</html>
